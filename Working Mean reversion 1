from AlgorithmImports import *
import numpy as np
import pandas as pd
from io import StringIO

class RetrospectiveFluorescentPinkCobra(QCAlgorithm):

    def Initialize(self):
        self.SetStartDate(2019, 6, 28)  # Set Start Date
        self.SetEndDate(2021,12,25) # Set End Date
        self.SetCash(100000)  # Set Strategy Cash
        
        self.stocklist = ["SQ", "MMM"] # list of stocks to be traded
        self.number_of_stocks = len(self.stocklist) # number of stocks
        stock = 0
        self.list_of_securities = [] #lists that contains symbol object of each stock
        self.rsi = [] # list that contains rsi data of eachs stock
        self.bb = [] #list that contains rsi and bollinger band data of each stock
        
        for i in range(self.number_of_stocks):
            stock = self.AddEquity(self.stocklist[i], Resolution.Minute)
            stock.SetDataNormalizationMode(DataNormalizationMode.Raw)
            self.list_of_securities.append(stock.Symbol) 
            #adds symbol object to list of securities
            
            self.rsi.append(self.RSI(self.list_of_securities[i], 14,  MovingAverageType.Simple, Resolution.Daily))
            self.bb.append(self.BB(self.list_of_securities[i], 14, 2, MovingAverageType.Simple, Resolution.Daily))
            #adds rsi and bollinger band indicators for each stock
            
        self.SetBenchmark("SPY") #S&P 500 benchmark
        self.SetWarmup(timedelta(14)) #Warmup time for indicators


    def OnData(self, data):
        for l in range(self.number_of_stocks):
            if (data.Bars.ContainsKey(self.list_of_securities[l])) and (data[self.list_of_securities[l]] is not None) : #checks if data exists for that point in time
                
                price = data[self.list_of_securities[l]].Value #sets price of each stock
                
                if (self.rsi[l].IsReady) and (self.bb[l].IsReady):
                    rsi_value = self.rsi[l].Current.Value
                    upper_band = self.bb[l].UpperBand.Current.Value
                    lower_band = self.bb[l].LowerBand.Current.Value
                    #sets rsi, upper and lower band values at that point in time
                    
                    if (rsi_value < 30) and (price < lower_band) and (not self.Portfolio[self.list_of_securities[l]].Invested):
                        self.SetHoldings(self.list_of_securities[l], 1/self.number_of_stocks)
                        #buying condition ADD SENTIMENT ANALYSIS HERE
                
                    if (self.Portfolio[self.list_of_securities[l]].Invested) and (rsi_value > 70) and (price > upper_band):
                        self.Liquidate(self.list_of_securities[l])
                        #selling condition ADD SENTIMENT ANALYSIS HERE
